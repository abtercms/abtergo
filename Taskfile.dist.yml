version: '3'

vars:
  PACKAGES:
    sh: find . -name '*.go' | grep -v -e mocks | xargs -n1 dirname | sort -u | tr '\n' ' '
    msg: failed to find PACKAGES

tasks:
  clean:
    sources:
    - libs/**/*.go
    - pkg/**/*.go
    cmds:
    - rm -rvf mocks build coverprofile.txt
    - mkdir mocks

  generate:
    deps: [clean]
    sources:
    - mocks/**/*.go
    - libs/**/*.go
    - pkg/**/*.go
    cmds:
    - mockery
    - go generate {{.PACKAGES}}

  lint:
    sources:
    - app/**/*.go
    - libs/**/*.go
    - pkg/**/*.go
    cmds:
    - golangci-lint --version
    - golangci-lint run {{.PACKAGES}}

  unit:
    sources:
    - libs/**/*.go
    - pkg/**/*.go
    cmds:
    - go test {{.PACKAGES}} -race -count=1 -mod=readonly -cover -coverprofile coverprofile.txt

  integration:
    sources:
    - libs/**/*.go
    - pkg/**/*.go
    cmds:
    - go test {{.PACKAGES}} -race -count=1 -mod=readonly -cover -coverprofile coverprofile.txt -tags=integration

  doc:
    sources:
    - doc/*
    cmds:
    - for f in `ls doc/*.d2`; do `d2 --sketch --layout elk --theme 200 $f ${f%.d2}.svg`;done

  run:
    sources:
    - app/**/*.go
    - libs/**/*.go
    - pkg/**/*.go
    cmds:
    - go run app/cmd/* --port 38593 server

  install:
    cmds:
    # documentation via d2: https://github.com/terrastruct/d2/releases
    - go install oss.terrastruct.com/d2@latest
    # mocking via mockery: https://github.com/vektra/mockery/releases
    - go install github.com/vektra/mockery/v2@v2.20.0
    # formatting via gofumpt: https://github.com/mvdan/gofumpt/releases
    - go install mvdan.cc/gofumpt@latest
    # linting via golangci-lint: https://github.com/golangci/golangci-lint/releases
    - curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.53.1

  update:
    cmds:
    - go get -t -u ./...
    - go mod tidy

  default:
    deps: [generate, lint, unit]
    sources:
    - app/**/*.go
    - libs/**/*.go
    - pkg/**/*.go
    cmds:
      - go install app/cmd/*
